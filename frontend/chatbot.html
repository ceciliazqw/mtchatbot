<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot Messenger</title>
  <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    #welcome-message {
      margin: 20px;
      font-size: 24px;
      text-align: center;
    }
    df-messenger {
      z-index: 999;
      position: fixed;
      --df-messenger-font-color: #000;
      --df-messenger-font-family: Google Sans;
      --df-messenger-chat-background: #f3f6fc;
      --df-messenger-message-user-background: #d3e3fd;
      --df-messenger-message-bot-background: #fff;
      bottom: 16px;
      right: 16px;
    }
  </style>
</head>
<body>
  <div id="welcome-message">歡迎回來！</div>
  <df-messenger
    location="asia-northeast1"
    project-id="ww-ai-agent-demo"
    agent-id="9a687799-e142-4fbc-a0d0-110b63b7746f"
    language-code="zh-tw"
    max-query-length="-1">
    <df-messenger-chat-bubble chat-title="WW Insurance Agent"></df-messenger-chat-bubble>
  </df-messenger>
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>
  <script>
    // --- Helper function to safely parse JSON ---
    async function tryParseJson(response) {
        const text = await response.text();
        try {
            return JSON.parse(text);
        } catch (err) {
            console.error("Failed to parse JSON response:", text);
            return { error: "API response was not valid JSON", responseText: text };
        }
    } 

    // --- Main onload logic ---
    window.onload = function() {
      console.log("DEBUG: window.onload triggered."); 

      const username = localStorage.getItem('username');
      const welcomeMsg = document.getElementById('welcome-message');
      const dfMessenger = document.querySelector('df-messenger'); 

      // --- Welcome Message Logic ---
      if (username) {
        welcomeMsg.innerText = "歡迎回來！" + username;
      } else {
        welcomeMsg.innerText = "歡迎回來！Guest";
      }

      // --- Event Listener for Function Tool Calls ---
      if (dfMessenger) {
          console.log("DEBUG: Adding event listener for df-request-error and df-tool-requested");

          // Optional: Listen for general errors from df-messenger
          dfMessenger.addEventListener('df-request-error', function (event) {
              console.error('Dialogflow Request Error:', event.detail);
          });
          
          // Listen for requests to execute a function tool
          dfMessenger.addEventListener('df-tool-requested', async function (event) {
              const toolName = event.detail.toolCall.tool; // Tool resource name (might be long)
              // It's better to check against the *display name* if possible, 
              // otherwise you need the full resource name. Let's assume you named it 'ExecutePolicyApiCall'.
              // You might need to adjust this check based on the actual tool name logged.
              console.log(`DEBUG: Event 'df-tool-requested' received for tool: ${toolName}`);
              console.log("DEBUG: Event detail:", event.detail);

              // Check if it's the correct tool we want to handle client-side
              // IMPORTANT: Replace 'ExecutePolicyApiCall' if your tool display name is different, 
              // or check against the full resource name if needed.
              if (toolName.includes('ExecutePolicyApiCall')) { 
                  console.log("DEBUG: Handling tool:", toolName);
                  
                  const action = event.detail.toolCall.inputParameters?.action;
                  const token = localStorage.getItem('token');
                  const baseApiUrl = "https://mtchatbot-932847276366.asia-east1.run.app"; // Your API base URL
                  let apiUrl = "";
                  let outputParameters = {};
                  let requestSuccessful = false;
                  let errorMessage = "";

                  console.log(`DEBUG: Action requested: ${action}`);
                  console.log("DEBUG: Token retrieved from localStorage:", token ? "Found" : "Not Found!");

                  if (!token) {
                      errorMessage = "驗證失敗：找不到使用者 Token，請重新登入。";
                      console.error(errorMessage);
                  } else if (action === 'get_cost') {
                      apiUrl = `${baseApiUrl}/api/policy/cost`;
                  } else if (action === 'get_date') {
                      apiUrl = `${baseApiUrl}/api/policy/date`;
                  } else {
                      errorMessage = `內部錯誤：未知的動作 '${action}'`;
                      console.error(errorMessage);
                  }

                  // If we have a URL and a token, attempt the API call
                  if (apiUrl && token) {
                      console.log(`DEBUG: Calling API: GET ${apiUrl}`);
                      try {
                          const response = await fetch(apiUrl, {
                              method: 'GET',
                              headers: {
                                  'Authorization': `Bearer ${token}` // Construct header here
                              }
                          });

                          console.log(`DEBUG: API raw response status: ${response.status}`);

                          if (response.ok) { // Status code 200-299
                              const responseData = await tryParseJson(response); // Use helper to parse safely
                              console.log("DEBUG: API success response data:", responseData);
                              
                              if(responseData.error){ // Check if API returned an expected error structure
                                  errorMessage = responseData.error;
                              } else {
                                   if (action === 'get_cost' && responseData.policy_cost !== undefined) {
                                      outputParameters = { policy_cost: responseData.policy_cost };
                                      requestSuccessful = true;
                                  } else if (action === 'get_date' && responseData.policy_due_date !== undefined) {
                                      outputParameters = { policy_date: responseData.policy_due_date };
                                      requestSuccessful = true;
                                  } else {
                                      // API returned 200 OK but missing expected data
                                      errorMessage = "API 回應成功，但缺少預期的資料。";
                                      console.error(errorMessage, responseData);
                                  }
                              }
                          } else {
                              // Handle HTTP errors (4xx, 5xx)
                              const errorData = await tryParseJson(response);
                              errorMessage = `API 呼叫失敗 (狀態碼: ${response.status})` + (errorData.error ? `: ${errorData.error}` : '');
                              console.error(`API Error: ${response.status}`, errorData);
                              if (response.status === 401) {
                                  errorMessage = "驗證失敗 - Token 無效或缺失";
                              } else if (response.status === 404) {
                                   errorMessage = "找不到客戶或保單資料";
                              }
                          }
                      } catch (error) {
                          // Handle network errors or other fetch issues
                          errorMessage = `呼叫 API 時發生錯誤: ${error.message}`;
                          console.error("Fetch Error:", error);
                      }
                  } else if (!apiUrl && !errorMessage) {
                      // Should have been caught by invalid action check, but just in case
                      errorMessage = "內部錯誤：無法確定 API 路徑";
                      console.error(errorMessage);
                  }
                  
                  // --- Send result back to Dialogflow ---
                  if (requestSuccessful) {
                      console.log("DEBUG: Sending function_success with output:", outputParameters);
                      event.detail.dfMessenger.sendRequest('function_success', {
                          tool: toolName, // Send back the specific tool resource name received
                          outputParameters: outputParameters
                      });
                  } else {
                      console.log("DEBUG: Sending function_error with message:", errorMessage);
                      // Send error back using the error_message output parameter
                      event.detail.dfMessenger.sendRequest('function_error', {
                          tool: toolName, 
                          outputParameters: { error_message: errorMessage } 
                      });
                  }
              } else {
                  console.log(`DEBUG: Tool request received for unhandled tool: ${toolName}`);
                  // Optionally send back an error if an unexpected tool is called client-side
                  // event.detail.dfMessenger.sendRequest('function_error', { ... });
              }
          });

      } else {
          console.error("DEBUG: df-messenger element not found on window.onload.");
      }
    };
  </script>
  </body>
  </html>